@model FiveMinute.ViewModels.AccountViewModels.UserDetailViewModel

@{
	ViewData["Title"] = "Create";
}

@{
	string GetCreationTimeString(DateTime utcDateTime)
	{
		var localTime = TimeZoneInfo.ConvertTimeFromUtc(utcDateTime, TimeZoneInfo.Local);
		return localTime.ToString("dd.MM HH:mm");
	}

	string GetTimeAgoString(DateTime dateTime, TimeZoneInfo timeZone)
	{
		var localTime = TimeZoneInfo.ConvertTimeFromUtc(dateTime, timeZone);
		var timeSpan = DateTime.Now - localTime;

		if (timeSpan.TotalSeconds < 60)
			return $"{(int)timeSpan.TotalSeconds} секунд назад";
		else if (timeSpan.TotalMinutes < 60)
			return $"{(int)timeSpan.TotalMinutes} минут назад";
		else if (timeSpan.TotalHours < 24)
			return $"{(int)timeSpan.TotalHours} час{(timeSpan.TotalHours < 5 ? "" : "ов")} назад";
		else if (timeSpan.TotalDays < 7)
			return $"{(int)timeSpan.TotalDays} день{(timeSpan.TotalDays < 2 ? "" : "ей")} назад";
		else if (timeSpan.TotalDays < 30)
			return $"{(int)(timeSpan.TotalDays / 7)} недел{((int)(timeSpan.TotalDays / 7) == 1 ? "ю" : "ь")} назад";
		else if (timeSpan.TotalDays < 365)
			return $"{(int)(timeSpan.TotalDays / 30)} месяц{((int)(timeSpan.TotalDays / 30) == 1 ? "" : "ев")} назад";
		else
			return $"{(int)(timeSpan.TotalDays / 365)} год{((int)(timeSpan.TotalDays / 365) == 1 ? "" : "а")} назад";
	}
}
<h1>Создание теста</h1>

<div class="container pt-2">
	<div class="row">
		<!-- Left Column: Form Fields -->
		<div class="col-md-6 pt-1">
			<form asp-action="Create" asp-controller="FiveMinuteTest" method="post">
				<h5>Название теста</h5>
				<input name="Name" class="form-control mb-3" type="text" placeholder="Введите название теста" />

				<h5>Шаблон пятиминутки</h5>
				<div id="selected-template-view" class="mb-3">
					<p class="text-muted">Шаблон не выбран</p>
				</div>
				<input name="AttachedFMTId" id="selected-template-id" readonly type="hidden" />

				<input class="btn btn-success mt-3" id="submit" type="submit" value="Создать тест" />
			</form>
		</div>

		<!-- Right Column: Table with Search -->
		<div class="col-md-6">
			<h3>Ваши пятиминутки</h3>
			<input type="text" id="search" class="form-control mb-2" placeholder="Поиск пятиминутки" onkeyup="filterTable('templatesTable', 'search')" />
			<table id="templatesTable" class="table ">
				<thead>
					<tr>
						<th>Название</th>
						<th>Время создания</th>
						<th>Последнее изменение</th>
						<th>Действие</th>
					</tr>
				</thead>
				<tbody>
					@foreach (var template in Model.FMTs)
					{
						<tr data-id="@template.Id"
							data-name="@template.Name"
							onclick="selectTemplate(this)"
							style="cursor: pointer;"
							class="align-middle">
							<td>@template.Id</td>
							<td>@template.Name</td>
							<td>@GetCreationTimeString(template.CreationTime)</td>
							<td>@GetTimeAgoString(template.LastModificationTime, TimeZoneInfo.Local)</td>
						</tr>
					}
				</tbody>
			</table>
		</div>
	</div>
</div>


<script>
	function filterTable(tableId, searchInputId) {
		var input = document.getElementById(searchInputId);
		var filter = input.value.toLowerCase();
		var table = document.getElementById(tableId);
		var rows = table.getElementsByTagName("tr");

		for (var i = 1; i < rows.length; i++) {
			var cells = rows[i].getElementsByTagName("td");
			var match = false;

			for (var j = 0; j < cells.length; j++) {
				if (cells[j] && cells[j].innerText.toLowerCase().includes(filter)) {
					match = true;
					break;
				}
			}

			rows[i].style.display = match ? "" : "none";
		}
	}

	function updateSelectedTemplate(id, name){
		var selectedTemplateView = document.getElementById('selected-template-view');
		var selectedTemplateIdInput = document.getElementById('selected-template-id');
		selectedTemplateView.innerHTML = `${id} ${name}`;
		selectedTemplateIdInput.value = id;
	}


	// Select a template by clicking on a row
	function selectTemplate(row) {
		var id = row.dataset.id;
		var name = row.dataset.name;

		var selectedTemplateView = document.getElementById('selected-template-view');
		var selectedTemplateIdInput = document.getElementById('selected-template-id');

		// Update selected template view
		selectedTemplateView.innerHTML = `<strong>Выбран шаблон:</strong> ${id} - ${name}`;
		selectedTemplateIdInput.value = id;

		// Highlight the selected row
		document.querySelectorAll("#templatesTable tr").forEach(r => r.classList.remove("table-primary"));
		row.classList.add("table-primary");
	}
</script>
